---
- hosts: localhost
  become: yes

  tasks:

    - name: install basic tools (git, curl, pip)
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - git
        - curl
        - python3.5
        - python-pip

    # npm is required by elasticdump and is not part of Debian stretch
    # repositories so we have to install it manually;
    # we install it through the nodejs package from node repo

    - name: add node repositories for npm installation
      shell: curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -

    - name: install npm (required by elasticdump)
      apt:
        name: nodejs
        state: present

    - name: create project directory
      file:
        path: /opt/applications/tornado-kibana-logs-handler
        state: directory

    - name: clone project
      git:
        repo: https://github.com/jean553/tornado-kibana-logs-handler.git
        dest: /opt/applications/tornado-kibana-logs-handler

    - name: install pip packages tox
      pip:
        name="tox"
        state=latest

    - name: create tox environment
      shell: >
        tox -r -e devdocker
      args:
        chdir: "/opt/applications/tornado-kibana-logs-handler"
        creates: "/opt/virtual_env35"

    - name: install elasticdump using npm
      npm:
        name: elasticdump
        global: yes
