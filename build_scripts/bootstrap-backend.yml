---
- hosts: localhost
  become: yes

  tasks:

    - name: basic tools installed (supervisor, nginx, git, curl, pip)
      apt:
        name: "{{ item }}"
        state: present
        update_cache: yes
      with_items:
        - supervisor
        - nginx
        - git
        - curl
        - python3.5
        - python-pip
        - htop
        - vim

    # npm is required by elasticdump and is not part of Debian stretch
    # repositories so we have to install it manually;
    # we install it through the nodejs package from node repo

    - name: node repositories activated (for npm download)
      shell: curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -

    - name: npm installed (required by elasticdump)
      apt:
        name: nodejs
        state: present

    - name: project directory created
      file:
        path: /opt/applications/aiohttp-elasticsearch-s3-logs-handler
        state: directory

    - name: aiohttp-elasticsearch-s3-logs-handler project cloned
      git:
        repo: https://github.com/jean553/aiohttp-elasticsearch-s3-logs-handler.git
        dest: /opt/applications/aiohttp-elasticsearch-s3-logs-handler

    - name: pip packages installed using tox
      pip:
        name="tox"
        state=latest

    - name: tox environment created
      shell: >
        tox -r -e aws
      args:
        chdir: "/opt/applications/aiohttp-elasticsearch-s3-logs-handler"
        creates: "/opt/virtual_env35"

    - name: elasticdump installed using npm
      npm:
        name: elasticdump
        global: yes

    - name: supervisor configuration copied into supervisor directory
      copy:
        src: /opt/applications/aiohttp-elasticsearch-s3-logs-handler/build_scripts/supervisor.conf
        dest: /etc/supervisor/conf.d/aiohttp-elasticsearch-s3-logs-handler.conf

    - name: nginx site configuration copied into nginx directory
      copy:
        src: /opt/applications/aiohttp-elasticsearch-s3-logs-handler/build_scripts/nginx.conf
        dest: /etc/nginx/sites-available/default
